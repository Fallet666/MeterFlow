# MeterFlow

Простое клиент-серверное приложение для учёта показаний коммунальных счётчиков с аналитикой и прогнозом начислений.

## Архитектура
- **Backend:** Django + Django REST Framework, JWT-аутентификация через `djangorestframework-simplejwt`.
- **Database:** PostgreSQL (по умолчанию SQLite для локальной разработки).
- **Frontend:** React + Vite, маршрутизация на React Router 7, графики на Recharts.
- **Инфраструктура:** Docker Compose поднимает API, PostgreSQL и SPA.

## Функциональность
- Регистрация и вход через JWT.
- Управление объектами недвижимости и счётчиками.
- Ввод показаний с автоматическим расчётом помесячных начислений по тарифам.
- Учёт тарифов, платежей, просмотр начислений и аналитики.
- Прогноз суммы начислений за текущий месяц.

## Быстрый запуск без Docker
1. **Backend**
   ```bash
   cd backend
   python -m venv .venv
   source .venv/bin/activate
   pip install -r requirements.txt
   python manage.py migrate
   python manage.py runserver 0.0.0.0:8000
   ```
   По умолчанию используется SQLite. Для PostgreSQL задайте переменные окружения:
   ```bash
   export DB_ENGINE=postgres
   export POSTGRES_DB=meterflow
   export POSTGRES_USER=meterflow
   export POSTGRES_PASSWORD=meterflow
   export POSTGRES_HOST=localhost
   export POSTGRES_PORT=5432
   ```
2. **Frontend**
   ```bash
   cd frontend
   npm install
   npm run dev -- --host --port 5173
   ```
   По умолчанию фронтенд ожидает API по адресу `http://localhost:8000/api/`. При необходимости задайте `VITE_API_URL`.

## Запуск через Docker Compose
```bash
docker-compose up --build
```
- Backend: http://localhost:8000
- Frontend: http://localhost:5173
- PostgreSQL: порт 5432, учётные данные в `docker-compose.yml` или `backend/.env.example`.
- Frontend-контейнер проксирует `/api/` в backend, поэтому из браузера используются относительные запросы. Значение API-URL передаётся на этапе сборки через аргумент `FRONTEND_VITE_API_URL` (по умолчанию `/api/`):  
  ```bash
  FRONTEND_VITE_API_URL=https://example.com/api/ docker compose up -d --build frontend
  ```
  Если фронтенд опубликован под доменом, убедитесь, что внешняя точка входа (nginx/Ingress) также проксирует `/api/` на backend:8000.

### Прогон тестов через Docker Compose
- Все сервисы + тестовые контейнеры:
  ```bash
  docker compose --profile test up --build --abort-on-container-exit
  ```
- Только фронтенд-тесты без поднятия приложения:
  ```bash
  docker compose --profile test run --rm frontend-tests
  ```
- Только бэкенд-тесты (использует PostgreSQL из docker-compose):
  ```bash
  docker compose --profile test run --rm backend-tests
  ```
Профиль `test` добавляет отдельные контейнеры для прогонки тестов и не влияет на обычный деплой через `docker-compose up`.

## Основные эндпоинты
- `POST /api/auth/register/` — регистрация пользователя с мгновенной выдачей токенов.
- `POST /api/auth/login/` — получение JWT.
- CRUD: `/api/properties/`, `/api/meters/`, `/api/readings/`, `/api/tariffs/`, `/api/payments/`.
- `GET /api/monthly-charges/` — начисления (read-only).
- `GET /api/analytics/` — агрегированные данные для графиков.
- `GET /api/analytics/forecast/` — прогноз суммы за текущий месяц.

## Бизнес-логика
- При создании показания рассчитывается дельта по предыдущему чтению, подбирается актуальный тариф и обновляется соответствующая запись `MonthlyCharge`.
- Прогноз вычисляется как среднее начислений за последние несколько полных месяцев.

## UI-страницы
- Авторизация/регистрация.
- Дашборд с выбором объекта, прогнозом и последними показаниями.
- Объекты, счётчики, показания.
- Аналитика с графиками начислений и потребления (Recharts).

## Тестирование
- **Backend (pytest + pytest-django):** покрыты модели, сериализаторы, ключевые API и аналитика. Перед запуском убедитесь, что зависимости установлены и применены миграции. Команда: `cd backend && pytest`.
- **Frontend (Vitest + Testing Library):** компонентные тесты страниц авторизации, дашборда, показаний и аналитики с моками API. Команда: `cd frontend && npm test`.
- Для PostgreSQL задайте переменные окружения `DB_ENGINE=postgres` и параметры подключения перед запуском тестов, либо оставьте SQLite по умолчанию.
- Фронтенду нужен `npm install` и актуальное значение `VITE_API_URL`, если API работает не на `http://localhost:8000/api/`.

## Типовой сценарий для нового разработчика
1. Установите зависимости:
   ```bash
   cd backend && python -m venv .venv && source .venv/bin/activate
   pip install -r requirements.txt
   cd ../frontend && npm install
   ```
2. Подготовьте базу и переменные окружения (при необходимости PostgreSQL с `DB_ENGINE=postgres`). Выполните миграции:
   ```bash
   cd backend
   source .venv/bin/activate
   python manage.py migrate
   ```
3. Запустите сервисы локально:
   ```bash
   # Backend
   cd backend && source .venv/bin/activate && python manage.py runserver 0.0.0.0:8000
   # Frontend (в другом терминале)
   cd frontend && npm run dev -- --host --port 5173
   ```
4. Прогоните тесты:
   ```bash
   cd backend && pytest
   cd ../frontend && npm test
   ```
5. Для проверки всего стека через контейнеры используйте `docker-compose up --build` — это поднимет API, базу и SPA.

## Тесты и тест-кейсы

### Автоматические тесты

#### Backend (`pytest`)
- `core/tests/test_models.py` — строковые представления моделей, корректный подбор тарифов и формирование начислений при обработке показаний.
- `core/tests/test_serializers.py` — присвоение владельца в `PropertySerializer`, валидация счётчиков по владельцу и расчёт дельт/сумм в `ReadingSerializer`.
- `core/tests/test_api.py` — e2e-потоки: регистрация/логин с JWT, фильтрация объектов по пользователю, запрет создания счётчика для чужого объекта, пересчёт `MonthlyCharge` при создании показания, валидация платежей, CRUD тарифов, агрегации аналитики, обработка пустых данных и (новое) фильтрация `/api/monthly-charges/` только по своим объектам.
- `core/tests/test_services.py` — негативные сценарии сервиса начислений (отрицательные показания/откат) и проверка прогноза `forecast_property`, исключающего текущий месяц.

#### Frontend (`vitest` + Testing Library)
- `src/__tests__/AuthPage.test.tsx` — авторизация и регистрация: отправка форм, отображение ошибок API, переключение вкладок.
- `src/__tests__/AppNavigation.test.tsx` — условный роутинг по состоянию localStorage, загрузка сущностей и переходы между страницами.
- `src/__tests__/Dashboard.test.tsx` — рендер прогноза, последних показаний и карточек начислений после загрузки аналитики.
- `src/__tests__/ReadingsPage.test.tsx` — загрузка счётчиков/журнала, выбор счётчика и валидация ввода (запрет отправки некорректных значений).
- `src/__tests__/AnalyticsPage.test.tsx` — отображение агрегированных данных и graceful-degradation при ошибке API.
- `src/__tests__/PropertiesPage.test.tsx` — загрузка и добавление объектов, обязательное подтверждение паролем перед удалением со сверкой ошибок аутентификации.
- `src/__tests__/MetersPage.test.tsx` — работа со счётчиками: загрузка по объекту, валидация серийного номера, создание, переключение активности и удаление счётчика.

### Ручные тест-кейсы
1. **Регистрация + демо-данные**  
   - Зарегистрировать пользователя `test`.  
   - Убедиться, что после входа автоматически созданы объект недвижимости, тарифы и история показаний (дашборд заполняется данными).
2. **Управление объектами**  
   - Создать новый объект на странице «Объекты».  
   - Выбрать его активным, после чего открыть удаление и подтвердить корректным паролем — объект исчезает из списка, активным становится следующий.
3. **Управление счётчиками**  
   - Перейти в «Счётчики», выбрать объект, добавить прибор с уникальным серийником.  
   - Из списка изменить статус счётчика (деактивировать/активировать) и удалить его, убедившись, что таблица обновилась.
4. **Ввод показаний**  
   - Создать два последовательных показания по счётчику.  
   - Проверить, что начисления обновились на вкладке «Начисления» и прогноз на дашборде пересчитался.  
   - Попробовать внести показание меньше предыдущего — должно появиться предупреждение, а начисления не меняются.
5. **Платежи и аналитика**  
   - Добавить несколько платежей и перейти в «Аналитику».  
   - Проверить отображение суммарных значений, графиков и блока прогнозов.  
   - Отфильтровать данные по конкретному объекту или ресурсу и убедиться, что диаграммы подстраиваются под фильтр.
6. **Навигация и сессии**  
   - Авторизоваться, открыть вкладки «Показания», «Аналитика», «Объекты» и убедиться, что активный объект сохраняется в localStorage.  
   - Очистить токены и убедиться, что приложение возвращает на экран логина.
